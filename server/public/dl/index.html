<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Videonu İndir</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0f15; color:#fff; }
    .wrap { max-width: 640px; margin: 0 auto; padding: 24px; display:flex; flex-direction:column; gap:16px; }
    .card { background:#121826; border-radius:16px; padding:16px; }
    button { padding:14px 18px; font-size:18px; border-radius:12px; border:0; background:#1f6feb; color:#fff; cursor:pointer; }
    button.secondary { background:#263042; }
    .muted { opacity:.85; font-size:14px; line-height:1.4; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .hidden { display:none; }
    a.link { color:#9ecbff; text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Videonu İndir</h2>

    <div id="state" class="card">
      <div id="msg">Link hazırlanıyor…</div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnDownload" class="hidden">Videoyu indir / aç</button>
        <button id="btnShare" class="secondary hidden">Paylaş (iOS/Android)</button>
        <button id="btnCopy" class="secondary hidden">Linki kopyala</button>
      </div>
      <div id="fallback" class="muted hidden" style="margin-top:10px;">
        İpucu (iPhone): Video açıldıktan sonra ekranın altındaki <b>Paylaş</b> ikonuna basıp <b>“Videoyu Kaydet”</b> seçin.
        <br/>Android: Video açılınca <b>indir</b> veya <b>Paylaş</b> seçeneğini kullanın.
      </div>
    </div>

    <div class="card muted">
      Sorun mu yaşıyorsun?
      <ul>
        <li>Link açılmazsa tekrar dene (linkler süreli).</li>
        <li>İnternet zayıfsa indirme uzun sürebilir.</li>
      </ul>
    </div>
  </div>

  <script>
    // URLParam'dan key'i çek
    const params = new URLSearchParams(location.search);
    const key = params.get('key');

    const msgEl = document.getElementById('msg');
    const btnDownload = document.getElementById('btnDownload');
    const btnShare = document.getElementById('btnShare');
    const btnCopy = document.getElementById('btnCopy');
    const fallback = document.getElementById('fallback');

    let presignedUrl = null;

    async function fetchPresigned() {
      if (!key) {
        msgEl.textContent = 'Geçersiz bağlantı: key parametresi eksik.';
        return;
      }
      try {
        const r = await fetch(`/api/presign/get?key=${encodeURIComponent(key)}`);
        if (!r.ok) throw new Error('Presigned isteği başarısız');
        const data = await r.json();
        presignedUrl = data.getUrl;
        msgEl.textContent = 'Hazır! Videonu indirebilirsin.';
        btnDownload.classList.remove('hidden');
        btnCopy.classList.remove('hidden');
        fallback.classList.remove('hidden');

        // Web Share destekliyse paylaş butonunu göster
        if (navigator.share) {
          btnShare.classList.remove('hidden');
        }
      } catch (e) {
        console.error(e);
        msgEl.textContent = 'Link oluşturulamadı. Lütfen tekrar deneyin.';
      }
    }

    // 1) En uyumlu yol: doğrudan linki aç.
    // iOS Safari’de oynatıcı açılır → Share → “Videoyu Kaydet” ile Galeri’ye kaydedilebilir.
    btnDownload.addEventListener('click', () => {
      if (!presignedUrl) return;
      // Aynı sekmede açalım (iOS Save Video akışı daha düzgün)
      window.location.href = presignedUrl;
      // Alternatif: yeni sekme
      // window.open(presignedUrl, '_blank', 'noopener');
    });

    // 2) Paylaş (Web Share API). Bazı tarayıcılarda dosya paylaşımı için blob gerekir.
    // URL paylaşımı çoğu iOS/Android’de share sheet’i açar.
    btnShare.addEventListener('click', async () => {
      if (!presignedUrl) return;
      try {
        await navigator.share({ url: presignedUrl, title: 'Videom', text: 'Etkinlik videom' });
      } catch (e) {
        // Kullanıcı iptal edebilir; sessiz geç
        console.log('Share cancelled or unsupported', e);
      }
    });

    // 3) Link kopyalama
    btnCopy.addEventListener('click', async () => {
      if (!presignedUrl) return;
      try {
        await navigator.clipboard.writeText(presignedUrl);
        btnCopy.textContent = 'Kopyalandı!';
        setTimeout(() => (btnCopy.textContent = 'Linki kopyala'), 1500);
      } catch {
        // Kopyalama engelliyse kullanıcıya linki seçip kopyalamasını söyleyebiliriz
        alert('Kopyalama başarısız. Linki elle kopyalayın:\n' + presignedUrl);
      }
    });

    fetchPresigned();
  </script>
</body>
</html>
