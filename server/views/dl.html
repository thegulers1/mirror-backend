<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Videon HazÄ±r</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            color-scheme: dark
        }

        body {
            background: #0b0f15;
            color: #fff;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            text-align: center;
            padding: 24px
        }

        video {
            max-width: 100%;
            border-radius: 12px;
            margin: 18px 0
        }

        .btn {
            display: inline-block;
            margin: 8px 6px;
            padding: 14px 18px;
            font-size: 18px;
            border-radius: 12px;
            border: 0;
            background: #1f6feb;
            color: #fff;
            text-decoration: none
        }

        .btn.secondary {
            background: #263042
        }

        .warn {
            background: #3b2430;
            border: 1px solid #a24a6a;
            padding: 12px;
            border-radius: 12px;
            margin: 10px 0;
            display: none
        }

        .muted {
            opacity: .85;
            font-size: 14px;
            line-height: 1.4;
            max-width: 720px;
            margin: 0 auto
        }
    </style>
</head>

<body>
    <h2>Videon HazÄ±r ğŸ‰</h2>

    <!-- iOS in-app browser uyarÄ±sÄ± -->
    <div id="iabWarning" class="warn">
        Uygulama iÃ§i tarayÄ±cÄ±dasÄ±n. <b>Safariâ€™de aÃ§</b> butonuna bas; ardÄ±ndan paylaÅŸ menÃ¼sÃ¼nden <b>â€œVideoyu Kaydetâ€</b>
        Ã§Ä±kacaktÄ±r.
        <div style="margin-top:8px;">
            <a id="openInSafari" class="btn">Safariâ€™de AÃ§</a>
        </div>
    </div>

    <video id="vid" src="{{VIEW_URL}}" controls playsinline></video>

    <div>
        <button class="btn" id="saveGallery">ğŸ“² iPhone: Galeriye Kaydet</button>
        <a class="btn secondary" id="downloadFiles" href="{{PROXY_URL}}" rel="noopener">ğŸ“¥ Dosyalara Ä°ndir</a>
        <a class="btn secondary" id="openPlayer" href="{{VIEW_URL}}" target="_blank" rel="noopener">â–¶ï¸ Oynat & Uzun
            Bas</a>
    </div>

    <p class="muted" style="margin-top:10px">
        iPhone Ã¶neri: <b>Galeriye Kaydet</b>. Olmazsa <b>Safariâ€™de AÃ§</b> â†’ oynatÄ±cÄ±da uzun bas â†’ <b>â€œVideoyu
            Kaydetâ€</b>.
    </p>

    <script>
        (async function () {
            // server tarafÄ±nda bu placeholderâ€™larÄ± dolduruyorsun (send iÃ§inde replace edebilirsin):
            const viewUrl = "{{VIEW_URL}}";
            const proxyUrl = "{{PROXY_URL}}";

            const ua = navigator.userAgent || "";
            const isIOS = /iPhone|iPad|iPod/i.test(ua);

            // In-app browser tespiti (Instagram/FB/Twitter/Line/WeChat vs.)
            const isInApp = /(FBAN|FBAV|FB_IAB|Instagram|Line|MicroMessenger|Twitter|OKApp|TikTok|CriOS\/[\d.]+ Mobile)/i.test(ua);

            // UyarÄ± kutusunu gÃ¶ster ve Safari'de aÃ§ butonuna viewUrl ver
            const warn = document.getElementById('iabWarning');
            const openInSafari = document.getElementById('openInSafari');
            if (isIOS && isInApp) {
                warn.style.display = 'block';
                openInSafari.onclick = () => { window.location.href = viewUrl; };
            }

            // â€œDosyalara Ä°ndirâ€ linki (proxy) â€” iOS'ta indirme diyalogu aÃ§ar
            document.getElementById('downloadFiles').href = proxyUrl;

            // â€œOynat & Uzun Basâ€ â€” her zaman Ã§alÄ±ÅŸÄ±r
            document.getElementById('openPlayer').href = viewUrl;

            // â€œGaleriye Kaydetâ€ â€” Web Share Level 2 (files) destekliyse Photosâ€™a kaydet seÃ§eneÄŸi gelir
            const saveBtn = document.getElementById('saveGallery');
            if (!isIOS) saveBtn.textContent = "ğŸ“¤ PaylaÅŸ (MP4)";

            async function saveToGallery() {
                try {
                    // MinIOâ€™dan MP4â€™Ã¼ blob olarak Ã§ek
                    const r = await fetch(viewUrl);
                    if (!r.ok) throw new Error('fetch failed: ' + r.status);
                    const blob = await r.blob();
                    const file = new File([blob], 'mirror-video.mp4', { type: 'video/mp4' });

                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({ files: [file], title: 'Mirror Video', text: 'Videomu kaydet' });
                        return;
                    }
                    // Share yoksa en garantili yol: oynatÄ±cÄ±ya gÃ¶nder (uzun bas â†’ Videoyu Kaydet)
                    window.location.href = viewUrl;
                } catch (e) {
                    console.log('share fallback', e);
                    window.location.href = viewUrl;
                }
            }
            saveBtn.addEventListener('click', saveToGallery);
        })();
    </script>
</body>

</html>